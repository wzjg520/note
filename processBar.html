<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	#canvas:{
		display:block;
		margin:100px auto;
		background:#ccc;
	}
	@font-face{ 
		font-family:"abc";
		src:url("BebasNeue.otf");
	}
</style>
</head>
<body>
<canvas id="canvas" width="500" height="500"/>
<script>
	
	var progressBar = function(element){
		var canvas = element,
			ctx = canvas.getContext("2d"),
			w = canvas.width,
			h = canvas.height,
			deg = 0,
			new_deg = 0,
			dif = 0,
			totalTime = 3000,
			startColor = 'green',
			endColor = 'red',
			strokeColor = 'yellow',
			fillColor = "#666",
			font = "50px arial",
			lineWidth = 5,
			radius = (w+h-2*lineWidth)/4,
			closeCallback,
			fontoffset = 5,
			loop,text,text_w,close;
			var init = function(){
				ctx.clearRect(0,0,w,h);
				ctx.beginPath();
				ctx.strokeStyle = strokeColor;
				ctx.arc(w/2, h/2, radius, 0, Math.PI*2,false);
				ctx.stroke();
				
				var r= deg*Math.PI/180;
				ctx.beginPath();
				var my_gradient = ctx.createLinearGradient(0, 0, w, h);
				my_gradient.addColorStop(0.5, startColor);
				my_gradient.addColorStop(1, endColor);
				ctx.strokeStyle = my_gradient;
				ctx.lineWidth = lineWidth;
				ctx.arc(w/2,h/2,radius,0-97*Math.PI/180,r-90*Math.PI/180,false);
				ctx.stroke();
				
				ctx.fillStyle = fillColor;
				ctx.font = font;

				text = Math.ceil(deg/360*100)+"%";
				text_w = ctx.measureText(text).width;
				console.log(ctx.measureText(text))
				ctx.fillText(text,w/2 - text_w/2,h/2+fontOffset);
			}
			
			var draw = function(callback){
				new_deg += Math.round(Math.random()*(360-new_deg));
				dif = new_deg-deg;				
				loop = setInterval(to,totalTime/dif);
				//执行成功后回调
				callback && (closeCallback = callback);
			}
			
			var to = function(){
				if(text == '100%'){
					clearInterval(loop);
					closeCallback && closeCallback(canvas);
					return;
				}
				if(deg == new_deg){
					clearInterval(loop);
					draw();
				}				
				
				if(deg<new_deg){
					deg++;
				}else{
					deg--;
				}
				init();
			}
			
			setOpt = function(obj){
				w = obj.width || w,	//x
				h = obj.height || h,	//y
				deg = obj.deg || deg,	//默认加载的loading角度
				fillColor = obj.fillColor || fillColor,	//loading内文字颜色
				font = obj.font || font,	//文字大小及字体
				strokeColor = obj.strokeColor || strokeColor, //loading边框颜色
				startColor = obj.startColor || startColor, //渐变颜色1
				endColor = obj.endColor || endColor,	//渐变颜色2				
				totalTime = obj.totalTime || totalTime;	//加载缓冲时间，不精确
				lineWidth = obj.lineWidth || lineWidth;	//loading边框宽度
				radius = obj.radius || radius //loading半径
				fontOffset = obj.fontOffset || fontoffset
			}
			
			close = function(callback){
				deg = 360;
				callback && callback();
			}
			return {
				draw : draw,
				setOpt : setOpt,
				close : close
			}
	}
	
	window.onload = function(){
		var progress = new progressBar(document.getElementById("canvas"));
		progress.setOpt({
			startColor:'green',
			endColor:'red',
			font:'150px arial',
			lineWidth:20,
			radius:200,
			fontOffset:50,
			totalTime:100
		});
		progress.draw();
	}
</script>	
	
</body>
</html>